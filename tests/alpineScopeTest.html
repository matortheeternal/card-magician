<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.js"></script>
    <title>Test</title>
</head>
<body>
<div x-data="{ user: { name: 'Alice', address: { city: 'Paris' } } }">
    <div x-scope="user">
        <p>Name: <span x-text="name"></span></p>
        <div x-scope="address">
            <p>City: <span x-text="city"></span></p>
        </div>
    </div>
    <form x-scope="user">
        <label>
            <span>Name</span>
            <input type="text" x-model="name" />
        </label>
        <section x-scope="address">
            <h2>Address</h2>
            <label>
                <span>City</span>
                <input type="text" x-model="city" />
            </label>
        </section>
    </form>
</div>

</body>

<script type="text/javascript">
    document.addEventListener('alpine:init', () => {
        Alpine.directive('scope', (el, { expression }, { evaluate, effect }) => {
            let parentScope = Alpine.closestDataStack(el)[0];
            let subScope = evaluate(expression);

            const path = expression.split('.');

            function getParentValue() {
                return path.reduce((acc, key) => acc?.[key], parentScope);
            }

            const proxy = new Proxy(subScope, {
                get(target, prop) {
                    // TODO: Support magics like $el, $refs, etc. if needed
                    if (prop in target) return target[prop];
                    const current = getParentValue();
                    return current?.[prop];
                },
                set(target, prop, value) {
                    const current = getParentValue();
                    if (current) current[prop] = value;
                    return true;
                }
            });

            effect(() => {
                const current = getParentValue();
                Object.assign(proxy, current);
            });

            Alpine.addScopeToNode(el, proxy);
            Alpine.initTree(el);
        });
    });
</script>

</html>
